# Zero2Ping

Often the first step of using a TCP/IP stack involves obtaining an IP address from a DHCP server on the network and being able to ping the board from the developer's computer.  Zero2Ping documents that journey for the TCP/IP stack within the MPLAB Harmony v3 framework using the SAME54 Xplained Pro evaluation board.

A minimal project like Zero2Ping is important for a couple of reasons.  One, MCC does not allow for migration of a project from one processor to another.  Two, most of the demos are point solutions that do not have ICMP server or DHCP client enabled.  Three, discerning the difference between necessary application code and the stack functionality is not clear.  What can be removed and where do I start with my application?  Four, due to a lack of ability to move a demo project to your own hardware, the value of the demo is limited.

Based on all of the above, what is needed are clear instructions on how to build a MPLAB Harmony v3 TCP/IP project from a blank project as this is the first thing everyone does with their custom hardware.  The Zero2Ping project demonstrates that ICMP server and DHCP client require **no** application code to function. 

## Building the Project

MPLAB Harmony has evolved over the past few years into its current state.  The framework is configured through MCC which is a recent change.  A lot of the documentation still refers to the prior configuration plugin called MHC.  This project was developed via MCC with the following products and versions (from the harmony-manifest-success.yml file):

```
# This file has been autogenerated by MPLAB Code Configurator. Please do not edit this file.
# Project "zero2ping" has been created by using mentioned Harmony 3 packages


project: zero2ping
creation_date: 2023-06-22T19:46:00.278-07:00[America/Los_Angeles]    # ISO 8601 format: https://www.w3.org/TR/NOTE-datetime
operating_system: Windows 10
mcc_mode: IDE            # [IDE|Standalone|Headless]
mcc_version: v5.3.7
mcc_core_version: v5.5.7
mplabx_version: v6.10        # if MPLAB X plugin only
harmony_version: v1.3.0
compiler: XC32 (v4.21) 

modules:
    - {name: "csp", version: "v3.17.0"}
    - {name: "core", version: "v3.13.0"}
    - {name: "dev_packs", version: "v3.17.0"}
    - {name: "wolfssl", version: "v5.4.0"}
    - {name: "net", version: "v3.9.2"}
    - {name: "bsp", version: "v3.16.0"}
    - {name: "crypto", version: "v3.8.0"}
    - {name: "CMSIS-FreeRTOS", version: "v10.5.1"}
```

One option that has always existed within MPLAB Harmony v3 is the ability to develop bare metal or with a real-time operating system (RTOS).  Zero2Ping was developed with FreeRTOS so that the application developer could utilize the RTOS for their application development as well.

## Configuring MPLAB Harmony v3 TCP/IP Stack

The git log for the project shows the steps taken to bring up the layers of the project and the issues found due defaults in the framework that prevented quick and easy progress while developing from a blank project.

The initial project graph needs to be built in MCC.  The picture below shows the required blocks for a static IP address and ICMP server (ping response) capability.

### Ping Project Graph

![Initial Project Graph](https://github.com/jharoian-mchp/zero2ping/blob/main/docs/images/PingProjectGraph.png?raw=true)

In order for this project to generate and function correctly, the following pin assignments were made.

### Pin Table

![Pin Table](https://github.com/jharoian-mchp/zero2ping/blob/main/docs/images/PinTable1.png?raw=true)

![PinTable2](/home/c14029/Projects/zero2ping/docs/images/PinTable2.png)

### Pin Diagram

![Pin Diagram](https://github.com/jharoian-mchp/zero2ping/blob/main/docs/images/PinDiagram.png?raw=true)

The SAME54 Xplained Pro schematics were invaluable in making sure the pin assignments were correct for the design.

## Critical Steps for Success

The items below are needed steps to ensure that the generated project actually functions on the hardware.  The initial generation did not show any response on the console and didn't function (no ping to the static IP address).

- Add Console System Service for messaging (used SERCOM0 on pins PA04 & PA05)
- Added static IP address in NetConfig block (instance – MAC).  Make sure this is an available IP address for your network configuration.
- Added Debug System Service (also attached to Console) for output on why TCP/IP stack was not initializing
- Use TCP/IP stack heap estimate to set heap for project (in System or Project Properties – linker – defaults to 1k needs 47k.  Set to 48k)
- Don’t use RTC for time source (Using RTC ends up with divide by zero exception)
- Connect pins for MAC to PHY based on schematic

The project generated at this point will show that the TCP/IP stack initialized on the console and the board will respond to a ping at the configured static IP address. 

## Add DHCP Client

Adding the DHCP Client turned out to be non-eventful.  Add the block and make sure that the TCP/IP flag for auto starting DHCP is enabled.

### Ping and DHCP Project Graph

![Final Project Graph](https://github.com/jharoian-mchp/zero2ping/blob/main/docs/images/FinalProjectGraph.png?raw=true)

Once generated and downloaded to the board, the board can be pinged with board name (zero2ping) which should respond at the IP address leased by the DHCP client.  No change in the console output that indicates a change in IP address is displayed.

## Tools I wish I had known about

In preparing images for this README document, I discovered the TCP/IP Configuration view in MCC.  The view interacts with the MCC Project Graph and would have made configuring this project much simpler and easier to understand.

![TCP/IP Configuration](https://github.com/jharoian-mchp/zero2ping/blob/main/docs/images/TCPIPConfiguration.png?raw=true)

Use this tool for adding more TCP/IP components.  One next step involves adding the DNS client.  Using this view should be helpful to that end.

## Resources

The docs directory contains the following:

- SAME54 Datasheet
- SAME54 Xplained Pro Schematics

Both documents were referred to frequently during the development of Zero2Ping.

